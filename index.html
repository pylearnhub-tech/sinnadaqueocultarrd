<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peri√≥dico Digital ‚Äî Portada viva</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ---------- Theme tokens ---------- */
    :root {
      --bg: #090d12;
      --surface: #0f141b;
      --glass: rgba(18,24,32,.6);
      --text: #e7edf3;
      --muted: #93a1af;
      --primary: #53b1fd;
      --accent: #22d3ee;
      --danger: #ef4444;
      --ok: #22c55e;
      --border: #22303f;
      --shadow: 0 12px 36px rgba(0,0,0,.45);
      --radius-lg: 18px;
      --radius: 14px;
      --radius-sm: 10px;
      --focus: 0 0 0 3px rgba(83,177,253,.35);
      --grad-1: radial-gradient(800px 400px at 0% -10%, rgba(83,177,253,.18), transparent 60%);
      --grad-2: radial-gradient(900px 450px at 100% -20%, rgba(34,211,238,.14), transparent 60%);
    }
    :root.light {
      --bg: #f6f8fc;
      --surface: #ffffff;
      --glass: rgba(255,255,255,.65);
      --text: #0c1217;
      --muted: #5e6b79;
      --primary: #2563eb;
      --accent: #0ea5e9;
      --danger: #dc2626;
      --ok: #16a34a;
      --border: #e6e8ee;
      --shadow: 0 12px 36px rgba(0,0,0,.08);
      --grad-1: radial-gradient(800px 400px at 0% -10%, rgba(37,99,235,.12), transparent 60%);
      --grad-2: radial-gradient(900px 450px at 100% -20%, rgba(14,165,233,.10), transparent 60%);
    }

    /* ---------- Global ---------- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: var(--grad-1), var(--grad-2), var(--bg);
      color: var(--text);
    }
    a { color: var(--primary); text-decoration: none; }
    a:hover { text-decoration: underline; }

    /* ---------- Layout ---------- */
    .app {
      display: grid;
      grid-template-columns: 320px minmax(0,820px) 380px;
      gap: 24px;
      max-width: 1500px;
      margin: 0 auto;
      padding: 24px;
    }
    @media (max-width: 1200px) {
      .app { grid-template-columns: 280px minmax(0,1fr); }
      .right { display: none; }
    }
    @media (max-width: 860px) {
      .app { grid-template-columns: minmax(0,1fr); padding: 12px; }
      .left { display: none; }
    }

    /* ---------- Panels ---------- */
    .panel {
      position: relative;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--glass), transparent 40%), var(--surface);
      box-shadow: var(--shadow);
      overflow: clip;
      transform: translateZ(0);
    }

    /* ---------- Sidebar ---------- */
    .brand {
      display: flex; align-items: center; gap: 14px;
      padding: 18px 18px 8px;
    }
    .logo {
      width: 40px; height: 40px; border-radius: 12px;
      background:
        conic-gradient(from 160deg, var(--primary), var(--accent), var(--primary));
      box-shadow: 0 10px 24px color-mix(in oklab, var(--primary) 50%, transparent);
      animation: float 5s ease-in-out infinite;
    }
    @keyframes float { 0%,100%{ transform: translateY(0)} 50%{ transform: translateY(-4px)} }
    .brand h1 { margin: 0; font-size: 20px; letter-spacing: .2px; }

    .nav { padding: 10px; display: grid; gap: 6px; }
    .nav .item {
      display:flex; align-items:center; gap: 12px;
      padding: 12px 14px; border-radius: var(--radius);
      background: transparent; border: 1px solid transparent; color: var(--text);
      cursor: pointer; user-select: none;
      transition: transform .1s ease, background .12s ease, border-color .12s ease;
    }
    .nav .item:hover { background: color-mix(in oklab, var(--surface) 78%, #000 22%); border-color: var(--border); transform: translateY(-1px); }
    .nav .item.active { background: color-mix(in oklab, var(--surface) 70%, #000 30%); border-color: var(--border); }

    .auth { padding: 18px; border-top: 1px solid var(--border); }
    .auth h3 { margin: 0 0 10px; font-size: 15px; color: var(--muted); }
    .user {
      display:flex; align-items:center; gap: 12px;
      padding: 12px; border-radius: var(--radius);
      background: color-mix(in oklab, var(--surface) 75%, #000 25%); border: 1px solid var(--border);
    }
    .avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }

    /* Switch */
    .switch {
      display:flex; align-items:center; gap: 10px; margin-top: 10px;
    }
    .switch label { font-size: 13px; color: var(--muted); }
    .toggle {
      position: relative; width: 48px; height: 26px;
      background: #2b3340; border-radius: 999px; cursor: pointer;
      transition: background .15s ease;
      box-shadow: inset 0 2px 6px rgba(0,0,0,.25);
    }
    .toggle::after {
      content: ""; position: absolute; top: 3px; left: 3px;
      width: 20px; height: 20px; border-radius: 50%;
      background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,.28);
      transition: left .15s ease, background .15s ease;
    }
    .toggle.checked { background: linear-gradient(135deg, var(--primary), var(--accent)); }
    .toggle.checked::after { left: 25px; background: #071018; }
    :root.light .toggle { background: #d1d6de; }
    :root.light .toggle.checked { background: linear-gradient(135deg, var(--primary), var(--accent)); }

    /* ---------- Compose button ---------- */
    .compose-btn {
      position: fixed; z-index: 50; right: 24px; bottom: 24px;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color: #071018; font-weight: 800;
      padding: 14px 18px; border: none; border-radius: 999px;
      box-shadow: 0 18px 28px color-mix(in oklab, var(--accent) 40%, transparent);
      display:flex; align-items:center; gap: 10px; cursor: pointer;
      transition: transform .12s ease, filter .12s ease;
    }
    .compose-btn:hover { transform: translateY(-2px); filter: brightness(1.05); }

    /* ---------- Feed header ---------- */
    .feed-header {
      display:flex; align-items:center; justify-content:space-between;
      padding: 14px 18px; border-bottom: 1px solid var(--border);
      position: sticky; top: 0;
      background: color-mix(in oklab, var(--surface) 85%, transparent);
      backdrop-filter: blur(8px);
      z-index: 10;
    }
    .feed-header h2 { margin: 0; font-size: 18px; }
    .filters { display:flex; gap: 8px; align-items:center; }
    .chip {
      padding: 8px 12px; border-radius: 999px; border: 1px solid var(--border);
      background: color-mix(in oklab, var(--surface) 80%, #000 20%);
      color: var(--muted); cursor: pointer; font-size: 13px;
      transition: transform .12s ease, border-color .12s ease, color .12s ease;
    }
    .chip:hover { transform: translateY(-1px); }
    .chip.active { color: var(--text); border-color: color-mix(in oklab, var(--border) 60%, var(--primary) 40%); }

    /* ---------- Modal ---------- */
    .modal { position: fixed; inset: 0; display: none; place-items: center; z-index: 100;
      background: rgba(7,10,14,.6); backdrop-filter: blur(6px); }
    .modal.open { display: grid; }
    .dialog {
      width: min(880px, 92vw); border-radius: var(--radius-lg);
      background: var(--surface); border: 1px solid var(--border); box-shadow: var(--shadow);
      overflow: hidden; animation: pop .18s ease-out;
    }
    @keyframes pop { from { transform: translateY(6px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .dialog .head { display:flex; align-items:center; justify-content:space-between; padding: 14px 18px; border-bottom: 1px solid var(--border); }
    .dialog .body { padding: 16px; display: grid; gap: 12px; }
    .row { display: grid; gap: 8px; }
    label { font-size: 13px; color: var(--muted); }
    input[type="text"], input[type="email"], input[type="password"], textarea, select {
      width: 100%; padding: 12px 12px; border-radius: var(--radius);
      border: 1px solid #2c3949; background: #121822; color: var(--text);
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    input:focus, textarea:focus, select:focus { outline: none; box-shadow: var(--focus); border-color: color-mix(in oklab, var(--primary) 60%, var(--border)); }
    :root.light input[type="text"], :root.light input[type="email"], :root.light input[type="password"], :root.light textarea, :root.light select {
      border-color: #d5dbe3; background: #fff; color: #0c1217;
    }

    .media-picker {
      display: grid; gap: 8px;
      border: 1px dashed #3a4757; border-radius: var(--radius);
      padding: 12px; background: #121822;
    }
    .previews { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 10px; }
    .preview { position: relative; border: 1px solid #303846; border-radius: 12px; overflow: hidden; background: #0e1217; }
    .preview img, .preview video { width: 100%; height: 130px; object-fit: cover; display: block; }
    .preview .remove { position: absolute; top: 6px; right: 6px; background: rgba(0,0,0,.5); color: #fff; border: none; border-radius: 9px; padding: 6px 8px; cursor: pointer; font-size: 12px; }

    .btn { padding: 10px 12px; border-radius: 12px; border: 1px solid #2f3847; background: #141a23; color: var(--text); cursor: pointer; font-weight: 700; transition: transform .1s ease; }
    .btn:hover { transform: translateY(-1px); }
    .btn.primary { background: linear-gradient(135deg, var(--primary), var(--accent)); color: #071018; border: none; }
    .btn.ghost { background: transparent; border-color: transparent; color: var(--muted); }
    .btn.danger { background: #1a1416; color: #fca5a5; border-color: #482b33; }
    .actions { display:flex; gap: 8px; justify-content: flex-end; padding: 10px 16px; border-top: 1px solid var(--border); }

    /* ---------- Feed ---------- */
    .feed { min-height: 60vh; }
    .card { border-bottom: 1px solid var(--border); padding: 14px 18px; display: grid; gap: 12px; animation: fadeIn .22s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(6px);} to { opacity: 1; transform: translateY(0);} }
    .card .meta { display:flex; gap: 8px; align-items:center; color: var(--muted); font-size: 13px; }
    .card h3 { margin: 0; font-size: 20px; letter-spacing: .2px; }
    .card p { margin: 0; color: #cbd5e1; line-height: 1.6; }
    :root.light .card p { color: #334155; }
    .gallery { display: grid; gap: 8px; grid-template-columns: repeat(2, 1fr); }
    .gallery img, .gallery video { width: 100%; border-radius: 14px; border: 1px solid var(--border); background: #0f1318; }

    .toolbar { display:flex; gap: 10px; align-items:center; color: var(--muted); font-size: 13px; }
    .toolbar button { background: transparent; color: var(--muted); border: 1px solid transparent; padding: 8px 12px; border-radius: 999px; cursor: pointer; }
    .toolbar button:hover { border-color: color-mix(in oklab, var(--border) 60%, var(--primary) 40%); color: var(--text); }

    /* ---------- Comments ---------- */
    .comments { display:grid; gap: 10px; margin-top: 6px; }
    .comment { display:grid; gap: 6px; border: 1px solid var(--border); border-radius: 12px; padding: 10px; }
    .comment .who { color: var(--muted); font-size: 12px; }

    /* ---------- Right panel ---------- */
    .right .section { padding: 14px 18px; border-bottom: 1px solid var(--border); }
    .right h3 { margin: 0 0 8px; font-size: 16px; }

    /* ---------- Toast ---------- */
    .toast { position: fixed; left: 50%; bottom: 22px; transform: translateX(-50%); background: #0d141d; border: 1px solid #384355; color: var(--text); padding: 10px 14px; border-radius: 12px; box-shadow: var(--shadow); display: none; z-index: 200; }
    .toast.show { display: inline-block; animation: fadeIn .22s ease-out; }
    :root.light .toast { background: #fff; border-color: #e5e7eb; color: #0e1217; }

    .error { color: #fca5a5; font-size: 13px; }
    .hidden { display: none !important; }
    .loading { opacity: .6; pointer-events: none; }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT -->
    <aside class="left panel">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Peri√≥dico Digital</h1>
      </div>

      <div class="nav">
        <button class="item active" data-view="latest">üì∞ √öltimas</button>
        <button class="item" data-view="local">üìç Local</button>
        <button class="item" data-view="world">üåç Mundo</button>
        <button class="item" data-view="tech">üíª Tecnolog√≠a</button>
        <button class="item" data-view="sports">üèÖ Deportes</button>
        <button class="item" data-view="profile">üë§ Perfil</button>
      </div>

      <div class="auth">
        <h3>Tu cuenta</h3>
        <div id="authSigned" class="user hidden">
          <img id="userAvatar" class="avatar" alt="Avatar">
          <div class="meta">
            <div id="userName" style="font-weight:700;">‚Äî</div>
            <div id="userHandle" style="color:var(--muted); font-size:13px;">@‚Äî</div>
          </div>
        </div>

        <div id="authActions" style="display:grid; gap:10px; margin-top:10px;">
          <button class="btn" id="openLogin">Iniciar sesi√≥n</button>
          <button class="btn" id="openRegister">Crear cuenta</button>
          <button class="btn danger hidden" id="logout">Cerrar sesi√≥n</button>

          <div class="switch">
            <label>Tema</label>
            <div id="themeSwitch" class="toggle" role="switch" aria-checked="false" tabindex="0"></div>
            <span id="themeLabel">Oscuro</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- CENTER -->
    <main class="center panel">
      <div class="feed-header">
        <h2 id="centerTitle">Portada</h2>
        <div class="filters">
          <button class="chip active" data-filter="all">Todo</button>
          <button class="chip" data-filter="video">Videos</button>
          <button class="chip" data-filter="image">Im√°genes</button>
          <button class="chip" data-filter="text">Solo texto</button>
        </div>
      </div>

      <section class="feed" id="feed"></section>
    </main>

    <!-- RIGHT -->
    <aside class="right panel">
      <div class="section">
        <h3>Tendencias</h3>
        <p style="color:var(--muted);">Titulares destacados del d√≠a con movimiento real.</p>
      </div>
      <div class="section">
        <h3>Bolet√≠n</h3>
        <p style="color:var(--muted);">Recibe noticias cada ma√±ana.</p>
        <div style="display:flex; gap:8px;">
          <input type="email" placeholder="Tu correo" aria-label="Correo para bolet√≠n" />
          <button class="btn">Suscribir</button>
        </div>
      </div>
    </aside>
  </div>

  <!-- Floating compose -->
  <button class="compose-btn" id="composeBtn">‚úçÔ∏è Publicar noticia</button>

  <!-- Compose modal -->
  <div class="modal" id="composeModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="composeTitle">
      <div class="head">
        <h3 id="composeTitle">Nueva noticia</h3>
        <button class="btn ghost" id="closeCompose">Cerrar</button>
      </div>
      <form class="body" id="composeForm">
        <div class="row">
          <label for="title">T√≠tulo</label>
          <input type="text" id="title" name="title" maxlength="140" placeholder="Titular claro y contundente" required />
        </div>
        <div class="row">
          <label for="body">Cuerpo</label>
          <textarea id="body" name="body" placeholder="Describe los hechos con claridad y verificaci√≥n" required></textarea>
        </div>
        <div class="row">
          <label>Medios</label>
          <div class="media-picker" id="dropArea">
            <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
              <input type="file" id="imageInput" accept="image/*" multiple hidden />
              <button type="button" class="btn" id="pickImage">Agregar im√°genes</button>
              <input type="file" id="videoInput" accept="video/*" multiple hidden />
              <button type="button" class="btn" id="pickVideo">Agregar videos</button>
              <span style="color:var(--muted); font-size:13px;">Arrastra archivos aqu√≠</span>
            </div>
            <div class="previews" id="previews"></div>
          </div>
        </div>
        <div class="row" style="display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <div>
            <label for="category">Secci√≥n</label>
            <select id="category" name="category">
              <option value="latest">√öltimas</option>
              <option value="local">Local</option>
              <option value="world">Mundo</option>
              <option value="tech">Tecnolog√≠a</option>
              <option value="sports">Deportes</option>
            </select>
          </div>
          <div>
            <label for="tags">Etiquetas</label>
            <input type="text" id="tags" name="tags" placeholder="Ej: transporte, educaci√≥n" />
          </div>
        </div>
        <div class="error" id="composeError" aria-live="polite"></div>
        <div class="actions">
          <button type="button" class="btn ghost" id="clearMedia">Limpiar medios</button>
          <button type="submit" class="btn primary" id="publishBtn">Publicar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Auth modal -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="authTitle">
      <div class="head">
        <h3 id="authTitle">Acceder</h3>
        <button class="btn ghost" id="closeAuth">Cerrar</button>
      </div>
      <form class="body" id="authForm">
        <div class="row">
          <label for="authMode">Modo</label>
          <select id="authMode">
            <option value="login">Iniciar sesi√≥n</option>
            <option value="register">Crear cuenta</option>
          </select>
        </div>
        <div class="row">
          <label for="email">Correo</label>
          <input type="email" id="email" name="email" placeholder="tucorreo@ejemplo.com" required />
        </div>
        <div class="row" id="nameRow" style="display:none;">
          <label for="displayName">Nombre p√∫blico</label>
          <input type="text" id="displayName" name="displayName" placeholder="Tu nombre o medio" />
        </div>
        <div class="row" id="avatarRow" style="display:none;">
          <label for="avatarInput">Foto de perfil</label>
          <input type="file" id="avatarInput" accept="image/*" />
        </div>
        <div class="row">
          <label for="password">Contrase√±a</label>
          <input type="password" id="password" name="password" placeholder="M√≠nimo 6 caracteres" minlength="6" required />
        </div>
        <div class="error" id="authError" aria-live="polite"></div>
        <div class="actions">
          <button type="submit" class="btn primary" id="authSubmit">Continuar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Profile edit modal -->
  <div class="modal" id="profileModal" aria-hidden="true">
    <div class="dialog">
      <div class="head">
        <h3>Editar perfil</h3>
        <button class="btn ghost" id="closeProfile">Cerrar</button>
      </div>
      <form class="body" id="profileForm">
        <div class="row">
          <label for="profileName">Nombre</label>
          <input type="text" id="profileName" />
        </div>
        <div class="row">
          <label for="profileBio">Bio</label>
          <textarea id="profileBio"></textarea>
        </div>
        <div class="row">
          <label for="profileAvatar">Avatar</label>
          <input type="file" id="profileAvatar" accept="image/*" />
        </div>
        <div class="actions">
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

 <!-- Firebase SDKs -->
<script type="module">
  // Reemplaza con tu configuraci√≥n de Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyB5mGkfLPYDUukAw_XjJUcUPVuhj6_gk0A",
    authDomain: "sin-nada-que-ocultar-rd.firebaseapp.com",
    projectId: "sin-nada-que-ocultar-rd",
    storageBucket: "sin-nada-que-ocultar-rd.firebasestorage.app",
    messagingSenderId: "1054622320892",
    appId: "1:1054622320892:web:dd3412dcb3ce781e0f2f79"
  };

  // Reemplaza con tu configuraci√≥n de Cloudinary
  const CLOUDINARY = {
    cloudName: "dxbahdjk1",
    unsignedPreset: "nearmemarketplace" // crea un upload preset unsigned para demos
  };

    /* ==================================== */

    // Import Firebase ESM
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, doc, addDoc, setDoc, getDoc, onSnapshot, query, orderBy, updateDoc, serverTimestamp, arrayUnion, arrayRemove, where } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* ---------- Utils ---------- */
    const el = (s) => document.querySelector(s);
    const els = (s) => Array.from(document.querySelectorAll(s));
    const toast = (msg) => { const t = el('#toast'); t.textContent = msg; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1800); };
    const sanitize = (str) => (str || '').replace(/[<>&]/g, (c) => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])).trim();

    /* ---------- Theme switch ---------- */
    const THEME_KEY = 'pd_theme';
    const applyTheme = (mode) => {
      document.documentElement.classList.toggle('light', mode === 'light');
      const toggle = el('#themeSwitch');
      toggle.classList.toggle('checked', mode === 'light');
      toggle.setAttribute('aria-checked', mode === 'light' ? 'true' : 'false');
      el('#themeLabel').textContent = mode === 'light' ? 'Claro' : 'Oscuro';
      localStorage.setItem(THEME_KEY, mode);
    };
    const initTheme = () => applyTheme(localStorage.getItem(THEME_KEY) || 'dark');
    const switchTheme = () => applyTheme(document.documentElement.classList.contains('light') ? 'dark' : 'light');
    el('#themeSwitch').addEventListener('click', switchTheme);
    el('#themeSwitch').addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); switchTheme(); } });

    /* ---------- Cloudinary upload ---------- */
    const uploadToCloudinary = async (file) => {
      const url = `https://api.cloudinary.com/v1_1/${CLOUDINARY.cloudName}/auto/upload`;
      const form = new FormData();
      form.append('file', file);
      form.append('upload_preset', CLOUDINARY.unsignedPreset);
      const res = await fetch(url, { method: 'POST', body: form });
      if (!res.ok) throw new Error('Error subiendo medios');
      const data = await res.json();
      return { url: data.secure_url, type: file.type.startsWith('video') ? 'video' : 'image' };
    };

    /* ---------- State ---------- */
    const state = { user: null, mediaFiles: [], filter: 'all', view: 'latest' };
    let unsubFeed = null;

    /* ---------- Session UI ---------- */
    const refreshSessionUI = async (user) => {
      const signed = !!user;
      el('#authSigned').classList.toggle('hidden', !signed);
      el('#logout').classList.toggle('hidden', !signed);
      el('#openLogin').classList.toggle('hidden', signed);
      el('#openRegister').classList.toggle('hidden', signed);

      if (signed) {
        const snap = await getDoc(doc(db, 'profiles', user.uid));
        const profile = snap.exists() ? snap.data() : { displayName: user.displayName || user.email.split('@')[0], handle: user.email.split('@')[0], avatar: '', bio: '' };
        el('#userName').textContent = profile.displayName;
        el('#userHandle').textContent = '@' + (profile.handle || user.email.split('@')[0]);
        el('#userAvatar').src = profile.avatar || 'https://via.placeholder.com/120?text=Avatar';
      }
    };

    /* ---------- Feed subscription ---------- */
    const subscribeFeed = () => {
      if (unsubFeed) unsubFeed();
      const qAll = query(collection(db, 'posts'), orderBy('createdAt', 'desc'));
      unsubFeed = onSnapshot(qAll, (snap) => {
        const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        const visible = all.filter(p => p.view === state.view);
        renderFeed(visible);
      });
    };

    /* ---------- Render feed ---------- */
    const renderFeed = (posts) => {
      const feed = el('#feed');
      if (state.view === 'profile') { renderProfilePage(); return; }

      const filtered = posts.filter(p => {
        const hasImage = (p.media || []).some(m => m.type === 'image');
        const hasVideo = (p.media || []).some(m => m.type === 'video');
        if (state.filter === 'all') return true;
        if (state.filter === 'text') return !(p.media || []).length;
        if (state.filter === 'image') return hasImage;
        if (state.filter === 'video') return hasVideo;
        return true;
      });

      if (!filtered.length) {
        feed.innerHTML = `<div class="card"><h3>Sin noticias en esta secci√≥n</h3><p>Publica con ‚ÄúPublicar noticia‚Äù.</p></div>`;
        return;
      }

      feed.innerHTML = filtered.map(p => {
        const gallery = (p.media || []).map(m => m.type === 'image' ? `<img src="${m.url}" alt="">` : `<video src="${m.url}" controls playsinline></video>`).join('');
        const liked = (p.likes || []).includes(state.user?.uid);
        const likeCount = (p.likes || []).length;
        const comments = (p.comments || []);
        const createdDate = p.createdAt?.toDate ? p.createdAt.toDate() : new Date(p.createdAt);
        return `
          <article class="card" data-id="${p.id}">
            <div class="meta">
              <span>${sanitize(p.authorName)} <span style="color:var(--muted);">@${sanitize(p.authorHandle)}</span></span>
              <span>‚Ä¢</span><span>${createdDate.toLocaleString('es-ES', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' })}</span>
              ${p.tags ? `<span>‚Ä¢</span><span>#${sanitize(p.tags)}</span>` : ''}
            </div>
            <h3>${sanitize(p.title)}</h3>
            <p>${sanitize(p.body)}</p>
            ${gallery ? `<div class="gallery">${gallery}</div>` : ''}
            <div class="toolbar">
              <button class="btn-like" data-id="${p.id}">${liked ? '‚ù§Ô∏è' : 'ü§ç'} Me gusta (${likeCount})</button>
              <button class="btn-comment-toggle" data-id="${p.id}">üí¨ Comentarios (${comments.length})</button>
              <button class="btn-share" data-id="${p.id}">üîÅ Compartir</button>
            </div>
            <div class="comments hidden" id="comments-${p.id}">
              <div class="row" style="grid-template-columns: 1fr auto; gap:8px;">
                <input type="text" placeholder="Tu comentario..." id="comment-input-${p.id}" />
                <button class="btn" data-id="${p.id}" id="comment-send-${p.id}">Enviar</button>
              </div>
              <div id="comment-list-${p.id}">
                ${comments.map(c => `
                  <div class="comment">
                    <div class="who">${sanitize(c.authorName)} ‚Ä¢ @${sanitize(c.authorHandle)}</div>
                    <div class="text">${sanitize(c.text)}</div>
                  </div>
                `).join('')}
              </div>
            </div>
          </article>
        `;
      }).join('');

      // Bind like
      feed.querySelectorAll('.btn-like').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          if (!state.user) { toast('Inicia sesi√≥n para dar like'); return; }
          const ref = doc(db, 'posts', id);
          const snap = await getDoc(ref);
          if (!snap.exists()) return;
          const likes = snap.data().likes || [];
          const hasLiked = likes.includes(state.user.uid);
          await updateDoc(ref, { likes: hasLiked ? arrayRemove(state.user.uid) : arrayUnion(state.user.uid) });
        });
      });

      // Toggle comments
      feed.querySelectorAll('.btn-comment-toggle').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          el(`#comments-${id}`)?.classList.toggle('hidden');
        });
      });

      // Send comment (instant + real-time update)
      filtered.forEach(p => {
        const sendBtn = el(`#comment-send-${p.id}`);
        if (sendBtn) {
          sendBtn.addEventListener('click', async () => {
            if (!state.user) { toast('Inicia sesi√≥n para comentar'); return; }
            const input = el(`#comment-input-${p.id}`);
            const text = sanitize(input.value);
            if (!text) return;
            const ref = doc(db, 'posts', p.id);
            // Optimistic UI: a√±adir al DOM al instante
            const list = el(`#comment-list-${p.id}`);
            const temp = document.createElement('div');
            temp.className = 'comment';
            temp.innerHTML = `
              <div class="who">${sanitize(state.user.displayName || state.user.email.split('@')[0])} ‚Ä¢ @${sanitize(state.user.email.split('@')[0])}</div>
              <div class="text">${sanitize(text)}</div>
            `;
            list.prepend(temp);
            input.value = '';
            // Persistencia
            await updateDoc(ref, {
              comments: arrayUnion({
                text,
                authorId: state.user.uid,
                authorName: state.user.displayName || state.user.email.split('@')[0],
                authorHandle: state.user.email.split('@')[0],
                createdAt: serverTimestamp()
              })
            });
          });
        }
      });

      // Share
      feed.querySelectorAll('.btn-share').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = e.currentTarget.dataset.id;
          const url = location.origin + location.pathname + `#post-${id}`;
          try { await navigator.clipboard.writeText(url); toast('Enlace copiado'); } catch { toast('No se pudo copiar'); }
        });
      });
    };

    /* ---------- Profile page ---------- */
    const renderProfilePage = async () => {
      const feed = el('#feed');
      if (!state.user) {
        feed.innerHTML = `<div class="card"><h3>Inicia sesi√≥n para ver tu perfil</h3></div>`;
        return;
      }
      const snap = await getDoc(doc(db, 'profiles', state.user.uid));
      const p = snap.exists() ? snap.data() : { displayName: state.user.displayName || state.user.email.split('@')[0], handle: state.user.email.split('@')[0], avatar: '', bio: '' };

      // Mis posts
      const qMine = query(collection(db, 'posts'), where('authorId','==', state.user.uid), orderBy('createdAt','desc'));
      const postsDiv = document.createElement('div');

      onSnapshot(qMine, (ds) => {
        const list = ds.docs.map(d => ({ id: d.id, ...d.data() }));
        postsDiv.innerHTML = list.map(post => `
          <article class="card">
            <div class="meta">
              <span>${sanitize(post.authorName)} ‚Ä¢ @${sanitize(post.authorHandle)}</span>
              <span>‚Ä¢</span><span>${(post.createdAt?.toDate ? post.createdAt.toDate() : new Date(post.createdAt)).toLocaleDateString('es-ES')}</span>
            </div>
            <h3>${sanitize(post.title)}</h3>
            <p>${sanitize(post.body)}</p>
          </article>
        `).join('') || `<p style="color:var(--muted);">A√∫n no publicas noticias.</p>`;
      });

      feed.innerHTML = `
        <div class="profile-header">
          <img src="${p.avatar || 'https://via.placeholder.com/120?text=Avatar'}" alt="Avatar">
          <div class="info">
            <div class="name">${sanitize(p.displayName)}</div>
            <div class="handle">@${sanitize(p.handle)}</div>
            <div class="bio">${sanitize(p.bio || '')}</div>
            <div style="display:flex; gap:8px; margin-top:8px;">
              <button class="btn" id="editProfileBtn">Editar perfil</button>
              <button class="btn" id="copyProfileLink">Compartir perfil</button>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Tus publicaciones</h3>
          <div id="myPosts"></div>
        </div>
      `;
      el('#myPosts').replaceWith(postsDiv);
      postsDiv.id = 'myPosts';

      el('#editProfileBtn').addEventListener('click', () => {
        el('#profileName').value = p.displayName || '';
        el('#profileBio').value = p.bio || '';
        el('#profileModal').classList.add('open');
        el('#profileModal').setAttribute('aria-hidden', 'false');
      });
      el('#copyProfileLink').addEventListener('click', async () => {
        const url = location.origin + location.pathname + `#user-${state.user.uid}`;
        try { await navigator.clipboard.writeText(url); toast('Perfil copiado'); } catch { toast('No se pudo copiar'); }
      });
    };

    /* ---------- Modals ---------- */
    const openCompose = () => {
      if (!state.user) { openAuth('login'); toast('Primero inicia sesi√≥n'); return; }
      el('#composeModal').classList.add('open'); el('#composeModal').setAttribute('aria-hidden', 'false');
      el('#composeError').textContent = ''; el('#composeForm').reset(); state.mediaFiles = []; el('#previews').innerHTML = '';
    };
    const closeCompose = () => { el('#composeModal').classList.remove('open'); el('#composeModal').setAttribute('aria-hidden', 'true'); };
    const openAuth = (mode = 'login') => {
      el('#authModal').classList.add('open'); el('#authModal').setAttribute('aria-hidden', 'false');
      el('#authMode').value = mode; el('#authError').textContent = '';
      el('#authForm').reset();
      const isRegister = mode === 'register';
      el('#nameRow').style.display = isRegister ? 'grid' : 'none';
      el('#avatarRow').style.display = isRegister ? 'grid' : 'none';
    };
    const closeAuth = () => { el('#authModal').classList.remove('open'); el('#authModal').setAttribute('aria-hidden', 'true'); };
    const closeProfile = () => { el('#profileModal').classList.remove('open'); el('#profileModal').setAttribute('aria-hidden', 'true'); };

    /* ---------- Media preview ---------- */
    const addFilesLocalPreview = async (files) => {
      const tasks = Array.from(files).slice(0, 6).map(file => new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve({ name: file.name, type: file.type.startsWith('video') ? 'video' : 'image', dataURL: reader.result, file });
        reader.readAsDataURL(file);
      }));
      const results = await Promise.all(tasks);
      state.mediaFiles.push(...results);
      renderPreviews();
    };
    const renderPreviews = () => {
      const wrap = el('#previews');
      wrap.innerHTML = state.mediaFiles.map((m, idx) => `
        <div class="preview">
          ${m.type === 'image' ? `<img src="${m.dataURL}" alt="${sanitize(m.name)}">` : `<video src="${m.dataURL}" controls></video>`}
          <button type="button" class="remove" data-index="${idx}">Eliminar</button>
        </div>
      `).join('');
      wrap.querySelectorAll('.remove').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const i = Number(e.currentTarget.dataset.index);
          state.mediaFiles.splice(i, 1);
          renderPreviews();
        });
      });
    };

    /* ---------- Navigation ---------- */
    els('.nav .item').forEach(b => b.addEventListener('click', () => {
      els('.nav .item').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      state.view = b.dataset.view;
      el('#centerTitle').textContent = b.dataset.view === 'profile' ? 'Perfil' : 'Portada';
      if (state.view === 'profile') renderProfilePage(); else subscribeFeed();
    }));

    els('.chip').forEach(c => c.addEventListener('click', () => {
      els('.chip').forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      state.filter = c.dataset.filter;
      // El feed se re-renderiza desde onSnapshot
    }));

    /* ---------- Compose ---------- */
    el('#composeBtn').addEventListener('click', openCompose);
    el('#closeCompose').addEventListener('click', closeCompose);
    el('#pickImage').addEventListener('click', () => el('#imageInput').click());
    el('#pickVideo').addEventListener('click', () => el('#videoInput').click());
    el('#imageInput').addEventListener('change', (e) => addFilesLocalPreview(e.target.files));
    el('#videoInput').addEventListener('change', (e) => addFilesLocalPreview(e.target.files));
    el('#clearMedia').addEventListener('click', () => { state.mediaFiles = []; renderPreviews(); });

    /* ---------- Publish (cierre inmediato del modal) ---------- */
    el('#composeForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const err = el('#composeError'); err.textContent = '';
      const btn = el('#publishBtn');

      if (!state.user) { err.textContent = 'Debes iniciar sesi√≥n.'; return; }
      const title = sanitize(el('#title').value);
      const body = sanitize(el('#body').value);
      const category = el('#category').value;
      const tags = sanitize(el('#tags').value);
      if (!title || !body) { err.textContent = 'T√≠tulo y cuerpo son obligatorios.'; return; }

      try {
        // UI loading + cierre inmediato del modal
        btn.classList.add('loading'); btn.disabled = true; btn.textContent = 'Publicando...';
        const profSnap = await getDoc(doc(db, 'profiles', state.user.uid));
        const profile = profSnap.exists() ? profSnap.data() : { displayName: state.user.displayName || state.user.email.split('@')[0], handle: state.user.email.split('@')[0] };
        const uploads = await Promise.all(state.mediaFiles.slice(0,4).map(m => uploadToCloudinary(m.file)));
        await addDoc(collection(db, 'posts'), {
          title, body, tags, media: uploads,
          authorId: state.user.uid,
          authorEmail: state.user.email,
          authorName: profile.displayName,
          authorHandle: profile.handle,
          createdAt: serverTimestamp(),
          view: category,
          likes: [],
          comments: []
        });
        // Cerrar modal y reset inmediato
        closeCompose();
        state.mediaFiles = []; el('#previews').innerHTML='';
        toast('Noticia publicada');
        // Volver a la secci√≥n del post
        state.view = category;
        els('.nav .item').forEach(x => x.classList.toggle('active', x.dataset.view === category));
        el('#centerTitle').textContent = 'Portada';
      } catch (ex) {
        err.textContent = ex.message || 'Error publicando.';
      } finally {
        btn.classList.remove('loading'); btn.disabled = false; btn.textContent = 'Publicar';
      }
    });

    /* ---------- Auth ---------- */
    el('#openLogin').addEventListener('click', () => openAuth('login'));
    el('#openRegister').addEventListener('click', () => openAuth('register'));
    el('#closeAuth').addEventListener('click', closeAuth);
    el('#logout').addEventListener('click', async () => { await signOut(auth); toast('Sesi√≥n cerrada'); });

    el('#authMode').addEventListener('change', (e) => {
      const isRegister = e.target.value === 'register';
      el('#nameRow').style.display = isRegister ? 'grid' : 'none';
      el('#avatarRow').style.display = isRegister ? 'grid' : 'none';
    });

    el('#authForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const mode = el('#authMode').value;
      const email = el('#email').value;
      const password = el('#password').value;
      const displayName = el('#displayName').value.trim();
      const avatarFile = el('#avatarInput').files?.[0];
      const err = el('#authError'); err.textContent = '';
      const btn = el('#authSubmit'); btn.disabled = true; btn.textContent = 'Procesando...';

      try {
        if (mode === 'register') {
          if (!displayName) throw new Error('Ingresa un nombre p√∫blico.');
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          let avatarUrl = '';
          if (avatarFile) { const up = await uploadToCloudinary(avatarFile); avatarUrl = up.url; }
          await updateProfile(cred.user, { displayName });
          const handle = email.split('@')[0];
          await setDoc(doc(db, 'profiles', cred.user.uid), { displayName, handle, avatar: avatarUrl, bio: '', createdAt: serverTimestamp() });
          toast('Cuenta creada'); closeAuth();
        } else {
          await signInWithEmailAndPassword(auth, email, password);
          toast('Sesi√≥n iniciada'); closeAuth();
        }
      } catch (ex) {
        err.textContent = ex.message || 'Error de autenticaci√≥n.';
      } finally {
        btn.disabled = false; btn.textContent = 'Continuar';
      }
    });

    /* ---------- Profile edit ---------- */
    el('#closeProfile').addEventListener('click', closeProfile);
    el('#profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!state.user) return;
      const name = sanitize(el('#profileName').value);
      const bio = sanitize(el('#profileBio').value);
      const avatarFile = el('#profileAvatar').files?.[0];

      try {
        let avatarUrl;
        if (avatarFile) { const up = await uploadToCloudinary(avatarFile); avatarUrl = up.url; }
        await updateDoc(doc(db, 'profiles', state.user.uid), { displayName: name, bio, ...(avatarUrl ? { avatar: avatarUrl } : {}) });
        if (name) await updateProfile(auth.currentUser, { displayName: name });
        toast('Perfil actualizado');
        closeProfile();
        refreshSessionUI(state.user);
        if (state.view === 'profile') renderProfilePage();
      } catch (ex) {
        toast(ex.message || 'Error actualizando perfil');
      }
    });

    /* ---------- Drag & drop compose ---------- */
    const dropArea = el('#dropArea');
    ['dragenter','dragover'].forEach(evt => dropArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropArea.style.borderColor = 'var(--primary)'; }));
    ['dragleave','drop'].forEach(evt => dropArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); dropArea.style.borderColor = '#3a4757'; }));
    dropArea.addEventListener('drop', (e) => addFilesLocalPreview(e.dataTransfer.files));

    /* ---------- Keyboard close modals ---------- */
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { closeCompose(); closeAuth(); closeProfile(); }
    });

    /* ---------- Auth state ---------- */
    onAuthStateChanged(auth, async (user) => {
      state.user = user || null;
      await refreshSessionUI(user);
      if (state.view === 'profile') renderProfilePage(); else subscribeFeed();
    });

    /* ---------- Init ---------- */
    initTheme();
    subscribeFeed();
  </script>
</body>
</html>
