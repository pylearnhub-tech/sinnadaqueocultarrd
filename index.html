<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>El Metro Diario ‚Äî Portada estilo Twitter profesional</title>
  <style>
    :root{
      --bg:#0b0e11; --card:#12161a; --text:#e8edf2; --muted:#9fb0c0;
      --accent:#1f67ff; --accent2:#ff6a3d; --border:#20252b; --card2:#0f1418;
      --headline:#f7fafc; --body:#dfe7ef; --shadow: 0 18px 44px rgba(0,0,0,.35);
      --ok:#39d98a; --warn:#ffcf5a; --err:#ff6b6b;
    }
    [data-theme="light"]{
      --bg:#f7f9fc; --card:#ffffff; --card2:#f2f4f8; --text:#12161c; --muted:#51606f;
      --border:#dfe5ec; --accent:#1f67ff; --accent2:#ff5c2b; --headline:#0e1216; --body:#2a3a48; --shadow: 0 16px 34px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    img{max-width:100%;display:block}

    /* Header */
    header{position:sticky;top:0;z-index:1000;background:rgba(11,14,17,0.8);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--border)}
    [data-theme="light"] header{background:rgba(255,255,255,.9)}
    .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:1180px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:0 10px 28px rgba(34,96,255,.22)}
    .brand h1{font-size:20px;margin:0;color:var(--headline)}
    .actions{display:flex;gap:10px;align-items:center}
    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer;transition:transform .06s, box-shadow .2s}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#4a86ff);border-color:var(--accent);color:white;box-shadow:0 10px 28px rgba(34,96,255,.22)}
    .btn.ghost{background:transparent}
    .btn:active{transform:scale(.98)}
    .switch{position:relative;width:48px;height:26px;border-radius:999px;background:var(--card2);border:1px solid var(--border);cursor:pointer}
    .knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .25s}
    [data-theme="dark"] .knob{background:linear-gradient(180deg,#20242a,#12161a)}
    .switch.active .knob{transform:translateX(22px)}

    /* Profile chip + menu */
    .headerProfile{position:relative}
    .profileChip{
      display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card2);cursor:pointer;
    }
    .profileAvatar{width:26px;height:26px;border-radius:999px;overflow:hidden;background:var(--card);border:1px solid var(--border)}
    .profileAvatar img{width:100%;height:100%;object-fit:cover}
    .profileName{font-size:12px;color:var(--muted);max-width:140px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .profileMenu{
      position:absolute;right:0;top:42px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);
      display:none;min-width:220px;padding:8px;animation:fadeIn .16s ease;
    }
    .profileMenuItem{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .profileMenuItem:hover{background:var(--card2)}
    .profileMenu hr{border:none;border-top:1px solid var(--border);margin:8px 0}

    .searchbar{display:flex;gap:8px;align-items:center;justify-content:center;padding:12px 16px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .searchbar input{flex:0 1 360px;background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;color:var(--text)}

    /* Layout principal */
    main{max-width:1180px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr;gap:20px}

    /* Feed estilo Twitter (columna izquierda) */
    .feed{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .section-title{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .tweetList{
      display:flex;flex-direction:column;align-items:flex-start;
      max-width:760px;
    }
    .tweet{
      width:100%;
      display:grid;grid-template-columns:56px 1fr;gap:12px;
      padding:14px 16px;border-bottom:1px solid var(--border);background:var(--card);
      animation:fadeIn .18s ease;
    }
    .tweet:hover{background:var(--card2)}
    .avatar{
      width:40px;height:40px;border-radius:999px;background:var(--card2);border:1px solid var(--border);
      display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px;overflow:hidden
    }
    .avatar img{width:100%;height:100%;object-fit:cover}
    .tweetHeader{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tweetTitle{font-size:20px;margin:0;color:var(--headline);font-weight:800}
    .tweetMeta{font-size:12px;color:var(--muted)}
    .tweetExcerpt{font-size:15px;color:var(--body);margin-top:6px}
    .tweetThumb{margin-top:10px;border-radius:12px;overflow:hidden;background:var(--card2)}
    .tweetThumb img{width:100%;height:auto;display:block;object-fit:cover}
    .tweetTags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{font-size:12px;color:#cfe7ff;background:var(--card2);border:1px solid var(--border);padding:4px 8px;border-radius:999px}
    [data-theme="light"] .tag{color:#284560}
    .tweetActions{display:flex;gap:12px;margin-top:10px}
    .react{font-size:12px;color:var(--muted);display:flex;gap:6px;align-items:center;cursor:pointer;user-select:none}
    .react.active{color:var(--accent2)}
    .feedStatus{font-size:12px;color:var(--muted);padding:8px 14px;border-top:1px solid var(--border)}

    /* Vista de lectura (encabezado izq, cuerpo centrado) */
    .postView{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow);display:none}
    .reader{padding:18px;max-width:760px;margin:0 auto}
    .cover{width:100%;border-radius:16px;overflow:hidden;background:var(--card2)}
    .cover img{width:100%;height:auto;max-height:520px;object-fit:cover}
    .readerTitle{margin:16px 0 6px;font-size:34px;color:var(--headline);font-family:Merriweather, Georgia, serif;text-align:left}
    .readerDeck{color:var(--body);font-size:18px;font-family:Merriweather, Georgia, serif;text-align:left}
    .readerMeta{color:var(--muted);font-size:13px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:6px;justify-content:flex-start}
    .readerTags{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
    .readerActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;justify-content:flex-start}
    .readerBody{
      margin-top:16px;line-height:1.85;font-size:18px;color:var(--body);
      text-align:center; /* solo cuerpo centrado */
      font-family:Merriweather, Georgia, serif;
    }
    .readerBody p{margin:0 0 14px 0}
    .readerBody h2,.readerBody h3{color:var(--headline);margin:20px 0 8px}
    .readerBody img{border-radius:14px;margin:12px auto;display:block}
    .readerFooter{display:flex;gap:8px;flex-wrap:wrap;border-top:1px solid var(--border);padding-top:12px;margin-top:16px;justify-content:center}

    /* Composer estilo Twitter (centrado y organizado) */
    .composerModal{position:fixed;inset:0;background:rgba(0,0,0,.65);display:none;align-items:center;justify-content:center;z-index:200;animation:fadeIn .16s ease}
    .tweetComposer{
      width:760px;max-width:96%;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);
      display:grid;grid-template-columns:56px 1fr;gap:12px;padding:14px 16px;animation:slideUp .18s ease;
    }
    .tweetComposer .avatar{width:40px;height:40px;border-radius:999px;background:var(--card2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:hidden}
    .tweetComposer .avatar img{width:100%;height:100%;object-fit:cover}
    .composerTop{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .composerTop .btn{border-radius:999px}
    .composerTitle input{
      width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text);
      font-size:18px;font-weight:700;text-align:center
    }
    .composerEditor{
      min-height:160px;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text);
    }
    .composerEditor[contenteditable="true"]{outline:none}
    .composerToolbar{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;justify-content:center}
    .uploader{text-align:center;margin-top:10px}
    .uploader input[type="file"]{display:inline-block}
    .previewImgs{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;justify-content:center}
    .previewImgs img{width:110px;height:110px;object-fit:cover;border-radius:12px;border:1px solid var(--border)}
    .composerActions{display:flex;gap:8px;justify-content:center;margin-top:10px}
    .composerActions .btn.primary{border-radius:999px;padding:8px 16px}
    .composeStatus{text-align:center;font-size:12px;color:var(--muted);margin-top:6px;min-height:18px}

    @keyframes fadeIn{from{opacity:.0} to{opacity:1}}
    @keyframes slideUp{from{transform:translateY(6px);opacity:.0} to{transform:none;opacity:1}}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>El Metro Diario</h1>
      </div>
      <div class="actions">
        <div id="themeSwitch" class="switch" title="Tema"><div class="knob"></div></div>

        <div class="headerProfile">
          <div id="profileChip" class="profileChip" style="display:none">
            <div class="profileAvatar"><img id="profileImg" alt=""></div>
            <div class="profileName" id="profileName">Mi cuenta</div>
          </div>
          <div id="profileMenu" class="profileMenu">
            <div class="profileMenuItem"><div class="profileAvatar"><img id="menuImg" alt=""></div><div id="menuName">Nombre</div></div>
            <hr />
            <div class="profileMenuItem" id="openComposerFromMenu">‚úçÔ∏è Nueva publicaci√≥n</div>
            <div class="profileMenuItem" id="logoutBtn">üö™ Cerrar sesi√≥n</div>
          </div>
        </div>

        <button id="loginBtn" class="btn">Iniciar sesi√≥n</button>
        <button id="openComposer" class="btn primary">Publicar</button>
      </div>
    </div>

    <div class="searchbar">
      <input id="q" type="search" placeholder="Buscar noticias..." />
    </div>
  </header>

  <main>
    <!-- Portada: timeline alineada a la izquierda -->
    <section class="feed">
      <div class="section-title"><strong>Portada</strong></div>
      <div id="tweetList" class="tweetList"></div>
      <div id="feedStatus" class="feedStatus"></div>
    </section>

    <!-- Lectura: encabezado a la izquierda, cuerpo centrado -->
    <section class="postView">
      <div class="section-title"><strong>Lectura</strong></div>
      <div class="reader">
        <div class="cover" id="viewCover"></div>
        <h1 class="readerTitle" id="viewTitle"></h1>
        <div class="readerDeck" id="viewDeck" style="display:none"></div>
        <div class="readerMeta">
          <span id="viewMeta"></span>
          <span>‚Ä¢</span>
          <span id="viewReadTime">‚è±Ô∏é 0 min</span>
        </div>
        <div class="readerTags" id="viewLabels"></div>
        <div class="readerActions">
          <button class="btn" id="viewShare">Compartir</button>
          <button class="btn" id="viewCopyLink">Copiar enlace</button>
          <button class="btn ghost" id="closePost">Volver</button>
          <div class="react" id="viewLike">‚ù§Ô∏è <span>0</span></div>
        </div>
        <div class="readerBody" id="viewContent"></div>
        <div class="readerFooter">
          <button class="btn ghost" id="backToFront">‚Üê Portada</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal composer tipo Twitter -->
  <div class="composerModal" id="composerModal">
    <div class="tweetComposer">
      <div class="avatar" id="composerAvatar"><img id="composerImg" alt="" style="display:none"><span id="composerFallback">ED</span></div>
      <div>
        <div class="composerTop">
          <strong>Crear publicaci√≥n</strong>
          <button class="btn" id="closeComposer">Cerrar</button>
        </div>
        <div class="composerTitle">
          <input type="text" id="newTitle" placeholder="Titular claro y legible" />
        </div>
        <div id="editor" class="composerEditor" contenteditable="true" spellcheck="true"></div>
        <div class="composerToolbar">
          <button class="btn" data-cmd="bold"><strong>B</strong></button>
          <button class="btn" data-cmd="italic"><em>I</em></button>
          <button class="btn" data-cmd="formatBlock" data-arg="H2">H2</button>
          <button class="btn" data-cmd="formatBlock" data-arg="H3">H3</button>
          <button class="btn" data-cmd="insertUnorderedList">‚Ä¢ Lista</button>
          <button class="btn" data-cmd="createLink" data-arg="https://">Link</button>
        </div>
        <div class="uploader">
          <input type="file" id="newImages" multiple accept="image/*" />
          <div class="previewImgs" id="previewImgs"></div>
        </div>
        <div class="composerActions">
          <button class="btn primary" id="publishBtn">Publicar</button>
        </div>
        <div id="composeStatus" class="composeStatus"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configuraci√≥n =====
    const BLOG_ID = "5213119795675357751";
    const API_KEY = "AIzaSyCARk0pc3s7y3VLUTi6LNuSpP-FD2l7OtI";
    const GOOGLE_CLIENT_ID = "723966225091-ge8ai8v13m60l7g9bma5b4hsuqmuh01n.apps.googleusercontent.com";

    // ===== Estado =====
    const state = {
      posts: [],
      likes: JSON.parse(localStorage.getItem("likes") || "{}"),
      theme: localStorage.getItem("theme") || "dark",
      user: null,            // { email, name, picture, accessToken }
      uploadDataUrls: []
    };

    // ===== Tema =====
    function applyTheme() {
      document.documentElement.setAttribute("data-theme", state.theme);
      const sw = document.getElementById("themeSwitch");
      sw.classList.toggle("active", state.theme === "light");
    }
    function toggleTheme() {
      state.theme = state.theme === "light" ? "dark" : "light";
      localStorage.setItem("theme", state.theme);
      applyTheme();
    }
    document.getElementById("themeSwitch").addEventListener("click", toggleTheme);
    applyTheme();

    // ===== Utilidades =====
    const fmtDate = iso => new Date(iso).toLocaleString("es-DO", { dateStyle: "medium", timeStyle: "short" });
    function escapeHtml(s=""){ return s.replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m])); }
    function cleanUnwanted(html){
      let safe = html || "";
      const unwanted = [
        "Noticiaswww.sinnadaqueocultarrd",
        "noticiaswww.sinnadaqueocultarrd.com",
        "www.sinnadaqueocultarrd.com",
        "sinnadaqueocultarrd.com"
      ];
      unwanted.forEach(s => { safe = safe.replaceAll(s, ""); });
      return safe;
    }
    function extractImages(html){
      const doc = new DOMParser().parseFromString(html, "text/html");
      return [...doc.querySelectorAll("img")].map(img => upscaleBloggerImage(img.src)).filter(Boolean);
    }
    function isLowRes(url=""){
      return /\/s(1?\d{2,3}|3\d{2})\//.test(url) || /=s(1?\d{2,3}|3\d{2})/.test(url);
    }
    function upscaleBloggerImage(url=""){
      if (!url) return url;
      try {
        return url
          .replace(/\/s\d+\//, "/s1600/")
          .replace(/=s\d+(-c)?/i, "=s1600")
          .replace(/w\d+-h\d+-p-k-no-nu\//i, "s1600/")
          .replace(/-w\d+-h\d+(-p)?/i, "");
      } catch { return url; }
    }
    function extractThumb(html){
      const imgs = extractImages(html);
      return imgs[0] || "";
    }
    function extractExcerpt(html, len=220){
      const text = new DOMParser().parseFromString(html, "text/html").body.textContent || "";
      return text.length > len ? text.slice(0, len).trim() + "‚Ä¶" : text;
    }
    function estimateReadTime(html){
      const text = new DOMParser().parseFromString(html, "text/html").body.textContent || "";
      const words = text.split(/\s+/).filter(Boolean).length;
      const mins = Math.max(1, Math.round(words / 200));
      const deck = text.split(/\s+/).filter(Boolean).slice(0, 28).join(" ");
      return { mins, words, deck };
    }
    function debounce(fn, wait){ let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

    // ===== Perfil: mostrar chip y men√∫ flotante =====
    function showProfileChip({name, email, picture}){
      const chip = document.getElementById("profileChip");
      const img = document.getElementById("profileImg");
      const nameEl = document.getElementById("profileName");
      const menu = document.getElementById("profileMenu");
      const menuImg = document.getElementById("menuImg");
      const menuName = document.getElementById("menuName");

      img.src = picture || "";
      img.style.display = picture ? "block" : "none";
      nameEl.textContent = name || email || "Mi cuenta";
      menuImg.src = picture || "";
      menuName.textContent = name || email || "Mi cuenta";
      chip.style.display = "flex";

      chip.onclick = () => {
        menu.style.display = (menu.style.display === "block") ? "none" : "block";
      };
      document.addEventListener("click", (e)=>{
        if (!chip.contains(e.target) && !menu.contains(e.target)) menu.style.display = "none";
      });
      document.getElementById("openComposerFromMenu").onclick = () => {
        menu.style.display = "none";
        openComposer();
      };
      document.getElementById("logoutBtn").onclick = logout;
    }

    // ===== Autenticaci√≥n Google OAuth (perfil + blogger) =====
    // Scopes: blogger + perfil/email para obtener imagen y nombre
    const OAUTH_SCOPES = [
      "https://www.googleapis.com/auth/blogger",
      "https://www.googleapis.com/auth/userinfo.email",
      "https://www.googleapis.com/auth/userinfo.profile",
      "openid"
    ].join(" ");

    (function setupAuth(){
      const s = document.createElement("script");
      s.src = "https://accounts.google.com/gsi/client";
      s.async = true;
      s.defer = true;
      s.onload = () => {
        document.getElementById("loginBtn").addEventListener("click", () => {
          const client = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: OAUTH_SCOPES,
            prompt: "consent",
            callback: async (resp) => {
              if (resp && resp.access_token) {
                try {
                  const ui = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", {
                    headers: { Authorization: `Bearer ${resp.access_token}` }
                  }).then(r => r.json());
                  state.user = {
                    accessToken: resp.access_token,
                    email: ui.email,
                    name: ui.name,
                    picture: ui.picture
                  };
                  document.getElementById("loginBtn").style.display = "none";
                  showProfileChip(state.user);
                  updateComposerAvatar(state.user);
                  notify("Autenticado. Ya puedes publicar.", "ok");
                } catch(e){
                  state.user = { accessToken: resp.access_token };
                  notify("Autenticado sin perfil. Intentar de nuevo.", "warn");
                }
              } else {
                notify("No se obtuvo token de acceso.", "err");
              }
            }
          });
          client.requestAccessToken();
        });
      };
      document.head.appendChild(s);
    })();

    function logout(){
      state.user = null;
      document.getElementById("profileChip").style.display = "none";
      document.getElementById("profileMenu").style.display = "none";
      document.getElementById("loginBtn").style.display = "inline-block";
      notify("Sesi√≥n cerrada.", "warn");
    }

    function updateComposerAvatar(user){
      const img = document.getElementById("composerImg");
      const fallback = document.getElementById("composerFallback");
      if (user?.picture) {
        img.src = user.picture;
        img.style.display = "block";
        fallback.style.display = "none";
      } else {
        img.style.display = "none";
        fallback.style.display = "inline";
      }
    }

    // ===== API Blogger (lectura) =====
    async function fetchPosts({ q = "", maxResults = 25 } = {}) {
      const params = new URLSearchParams({
        key: API_KEY,
        fetchBodies: "true",
        maxResults: String(maxResults),
        fields: "items(id,title,content,labels,author/displayName,published,url,selfLink),nextPageToken"
      });
      if (q) params.set("q", q);
      const url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Error al cargar posts");
      return res.json();
    }

    // ===== Feed (timeline izquierda) =====
    function renderFeed(items) {
      const list = document.getElementById("tweetList");
      list.innerHTML = "";
      if (!items || !items.length) {
        list.innerHTML = `<div style="padding:14px">No hay noticias para mostrar.</div>`;
        return;
      }
      items.forEach(p => {
        const thumb = extractThumb(p.content);
        const excerpt = extractExcerpt(p.content, 220);
        const labels = p.labels || [];
        const likeCount = state.likes[p.id]?.count || 0;
        const liked = !!state.likes[p.id]?.liked;
        const { mins } = estimateReadTime(p.content || "");

        const el = document.createElement("article");
        el.className = "tweet";
        const initials = (p.author?.displayName || "ED").slice(0,2).toUpperCase();
        el.innerHTML = `
          <div class="avatar"><span>${initials}</span></div>
          <div>
            <div class="tweetHeader">
              <h3 class="tweetTitle"><a href="#" data-id="${p.id}" class="open-post">${escapeHtml(p.title)}</a></h3>
              <span class="tweetMeta">‚Ä¢ ${fmtDate(p.published)} ‚Ä¢ Por ${escapeHtml(p.author?.displayName || "Desconocido")} ‚Ä¢ ‚è±Ô∏é ${mins} min</span>
            </div>
            <div class="tweetExcerpt">${escapeHtml(excerpt)}</div>
            ${thumb ? `<div class="tweetThumb"><img src="${thumb}" alt=""></div>` : ""}
            <div class="tweetTags">${labels.map(l => `<span class="tag">${escapeHtml(l)}</span>`).join("")}</div>
            <div class="tweetActions">
              <div class="react ${liked ? "active": ""}" data-like="${p.id}">‚ù§Ô∏è <span>${likeCount}</span></div>
              <div class="react" data-share="${p.id}">üîó Compartir</div>
            </div>
          </div>
        `;
        list.appendChild(el);
      });

      list.querySelectorAll(".open-post").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const id = a.getAttribute("data-id");
          const post = state.posts.find(x => x.id === id);
          if (post) {
            openPost(post);
            const url = new URL(location.href);
            url.searchParams.set("post", id);
            history.pushState({ view: "post", id }, "", url.toString());
          }
        });
      });
      list.querySelectorAll(".tag").forEach(t => {
        t.addEventListener("click", () => {
          document.getElementById("q").value = t.textContent;
          load();
        });
      });
      list.querySelectorAll("[data-like]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-like");
          toggleLike(id, btn);
        });
      });
      list.querySelectorAll("[data-share]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-share");
          const post = state.posts.find(x => x.id === id);
          sharePost(post);
        });
      });
    }

    // ===== Reacciones / compartir =====
    function toggleLike(id, btnEl){
      const like = state.likes[id] || { count: 0, liked: false };
      like.liked = !like.liked;
      like.count += like.liked ? 1 : (like.count>0 ? -1 : 0);
      state.likes[id] = like;
      localStorage.setItem("likes", JSON.stringify(state.likes));
      if (btnEl){
        btnEl.classList.toggle("active", like.liked);
        const span = btnEl.querySelector("span");
        if (span) span.textContent = like.count;
      }
    }
    async function sharePost(post){
      const shareData = { title: post.title, text: post.title, url: post.url || post.selfLink || location.href };
      try {
        if (navigator.share) await navigator.share(shareData);
        else {
          await navigator.clipboard.writeText(shareData.url);
          notify("Enlace copiado al portapapeles.", "ok");
        }
      } catch(e){ notify("No se pudo compartir.", "err"); }
    }
    function notify(msg, type="info") {
      const el = document.getElementById("feedStatus");
      const color = type==="ok" ? "var(--ok)" : type==="warn" ? "var(--warn)" : type==="err" ? "var(--err)" : "var(--muted)";
      el.style.color = color;
      el.textContent = msg;
      clearTimeout(notify._t);
      notify._t = setTimeout(()=>{ el.textContent = ""; }, 3500);
    }

    // ===== Lectura (encabezado izq, cuerpo centrado) =====
    function openPost(p) {
      document.querySelector(".feed").style.display = "none";
      document.querySelector(".postView").style.display = "block";

      const cleanedHtml = cleanUnwanted(p.content || "");
      const images = extractImages(cleanedHtml);

      // Portada: si la primera imagen es baja resoluci√≥n, no mostrar portada
      const first = images[0];
      const showCover = first && !isLowRes(first);
      const coverSrc = showCover ? first : "";

      const viewCover = document.getElementById("viewCover");
      viewCover.innerHTML = coverSrc ? `<img src="${coverSrc}" alt="Portada">` : "";

      document.getElementById("viewTitle").textContent = p.title;
      const { mins, words, deck } = estimateReadTime(cleanedHtml);
      document.getElementById("viewDeck").style.display = deck ? "block" : "none";
      document.getElementById("viewDeck").textContent = deck;
      document.getElementById("viewMeta").textContent = `${fmtDate(p.published)} ‚Ä¢ Por ${p.author?.displayName || "Desconocido"}`;
      document.getElementById("viewReadTime").textContent = `‚è±Ô∏é ${mins} min ‚Ä¢ ${words} palabras`;
      document.getElementById("viewLabels").innerHTML = (p.labels||[]).map(l=>`<span class="tag">${escapeHtml(l)}</span>`).join("");

      // Likes
      const like = state.likes[p.id] || { count: 0, liked: false };
      const viewLike = document.getElementById("viewLike");
      viewLike.classList.toggle("active", like.liked);
      viewLike.querySelector("span").textContent = like.count;
      viewLike.onclick = () => toggleLike(p.id, viewLike);

      // Toolbar
      document.getElementById("viewShare").onclick = () => sharePost(p);
      document.getElementById("viewCopyLink").onclick = async () => {
        const url = p.url || p.selfLink || location.href;
        try { await navigator.clipboard.writeText(url); notify("Enlace copiado.", "ok"); } catch(e){ notify("No se pudo copiar.", "err"); }
      };

      // Cuerpo: respetar HTML original, normalizando im√°genes (s1600) y centrando
      const body = document.getElementById("viewContent");
      body.innerHTML = "";
      const doc = new DOMParser().parseFromString(cleanedHtml, "text/html");

      doc.querySelectorAll("img").forEach(img => {
        img.src = upscaleBloggerImage(img.src || "");
        img.loading = "lazy";
        img.style.display = "block";
        img.style.margin = "12px auto";
        img.style.borderRadius = "14px";
      });

      [...doc.body.childNodes].forEach(node => {
        if (node.nodeType === 1) {
          body.appendChild(node);
        } else if (node.nodeType === 3 && node.textContent.trim()) {
          const pEl = document.createElement("p");
          pEl.textContent = node.textContent.trim();
          body.appendChild(pEl);
        }
      });

      const url = new URL(location.href);
      url.searchParams.set("post", p.id);
      history.pushState({ view: "post", id: p.id }, "", url.toString());
    }
    function closePost() {
      document.querySelector(".postView").style.display = "none";
      document.querySelector(".feed").style.display = "block";
    }
    document.getElementById("closePost").addEventListener("click", () => {
      closePost();
      const url = new URL(location.href);
      url.searchParams.delete("post");
      history.pushState({ view: "home" }, "", url.toString());
    });
    document.getElementById("backToFront").addEventListener("click", () => {
      closePost();
      const url = new URL(location.href);
      url.searchParams.delete("post");
      history.pushState({ view: "home" }, "", url.toString());
    });
    window.addEventListener("popstate", () => {
      const postId = new URLSearchParams(location.search).get("post");
      if (postId) {
        const post = state.posts.find(x => x.id === postId);
        if (post) openPost(post);
      } else {
        closePost();
      }
    });

    // ===== Composer =====
    const composerModal = document.getElementById("composerModal");
    function openComposer(){ composerModal.style.display = "flex"; updateComposerAvatar(state.user); }
    document.getElementById("openComposer").addEventListener("click", openComposer);
    document.getElementById("closeComposer").addEventListener("click", () => composerModal.style.display = "none");

    document.querySelectorAll(".composerToolbar .btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const cmd = btn.getAttribute("data-cmd");
        const arg = btn.getAttribute("data-arg") || null;
        if (cmd === "createLink") {
          const url = prompt("URL del enlace:", arg || "https://");
          if (url) document.execCommand(cmd, false, url);
        } else if (cmd === "formatBlock" && arg) {
          document.execCommand(cmd, false, arg);
        } else {
          document.execCommand(cmd, false, null);
        }
      });
    });

    document.getElementById("newImages").addEventListener("change", function(){
      const preview = document.getElementById("previewImgs");
      preview.innerHTML = "";
      state.uploadDataUrls = [];
      [...this.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = e => {
          const url = e.target.result;
          state.uploadDataUrls.push(url);
          const img = document.createElement("img");
          img.src = url;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    // ===== Publicar con manejo de 403 =====
    document.getElementById("publishBtn").addEventListener("click", async () => {
      const title = document.getElementById("newTitle").value.trim();
      const editor = document.getElementById("editor");
      const composeStatus = document.getElementById("composeStatus");
      if (!title) { composeStatus.style.color = "var(--err)"; composeStatus.textContent = "Pon un t√≠tulo claro."; return; }
      const contentHtml = editor.innerHTML + state.uploadDataUrls.map(url => `<p><img src="${url}" alt=""></p>`).join("");

      if (!state.user?.accessToken) {
        composeStatus.style.color = "var(--err)";
        composeStatus.textContent = "Inicia sesi√≥n para publicar.";
        return;
      }

      composeStatus.style.color = "var(--muted)";
      composeStatus.textContent = "Publicando‚Ä¶";

      try {
        const res = await fetch(`https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts/`, {
          method:"POST",
          headers:{ "Authorization": `Bearer ${state.user.accessToken}`, "Content-Type":"application/json" },
          body: JSON.stringify({ kind:"blogger#post", title, content: contentHtml })
        });
        if (!res.ok) {
          const t = await res.text();
          let hint = "";
          try {
            const j = JSON.parse(t);
            const code = j?.error?.code;
            const reason = j?.error?.errors?.[0]?.reason;
            if (code === 403 || reason === "forbidden") {
              hint = " ‚Ä¢ Verifica que la cuenta autenticada tenga rol de autor/administrador en este blog de Blogger y que el Client ID tenga el origen (localhost) autorizado.";
            }
          } catch {}
          throw new Error(t + hint);
        }
        composeStatus.style.color = "var(--ok)";
        composeStatus.textContent = "Publicado.";
        composerModal.style.display = "none";
        await load();
      } catch(err) {
        composeStatus.style.color = "var(--err)";
        composeStatus.textContent = "Error al publicar: " + (err.message || err);
      }
    });

    // ===== B√∫squeda =====
    document.getElementById("q").addEventListener("input", debounce(load, 350));

    // ===== Carga inicial =====
    async function load() {
      const q = document.getElementById("q").value.trim();
      const status = document.getElementById("feedStatus");
      status.style.color = "var(--muted)";
      status.textContent = "Cargando noticias‚Ä¶";
      try {
        const data = await fetchPosts({ q, maxResults: 25 });
        state.posts = data.items || [];
        renderFeed(state.posts);
        status.textContent = `Mostrando ${state.posts.length} noticias.`;
        restoreFromUrl();
      } catch (err) {
        status.style.color = "var(--err)";
        status.textContent = "No se pudieron cargar las noticias.";
      }
    }
    function restoreFromUrl(){
      const postId = new URLSearchParams(location.search).get("post");
      if (postId) {
        const post = state.posts.find(x => x.id === postId);
        if (post) openPost(post);
      }
    }

    load();
  </script>
</body>
</html>
