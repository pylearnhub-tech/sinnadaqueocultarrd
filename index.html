<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>El Metro Diario ‚Äî Hilo profesional</title>
  <style>
    :root{
      --bg:#0b0e11; --card:#12161a; --text:#e8edf2; --muted:#9fb0c0;
      --accent:#1f67ff; --accent2:#ff6a3d; --border:#20252b; --card2:#0f1418;
      --headline:#f7fafc; --body:#dfe7ef; --shadow:0 20px 48px rgba(0,0,0,.35);
      --ok:#39d98a; --warn:#ffcf5a; --err:#ff6b6b;
    }
    [data-theme="light"]{
      --bg:#f7f9fc; --card:#ffffff; --card2:#f2f4f8; --text:#12161c; --muted:#51606f;
      --border:#dfe5ec; --accent:#1f67ff; --accent2:#ff5c2b; --headline:#0e1216; --body:#2a3a48; --shadow:0 16px 34px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    a{color:var(--accent);text-decoration:none}
    img{max-width:100%;display:block}

    /* Header */
    header{position:sticky;top:0;z-index:1000;background:rgba(11,14,17,0.85);backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid var(--border)}
    .nav{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px;max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:38px;height:38px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    .brand h1{font-size:20px;margin:0;color:var(--headline)}
    .actions{display:flex;gap:10px;align-items:center}

    .btn{padding:8px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent),#4a86ff);color:white}
    .btn.ghost{background:transparent}

    /* Theme switch */
    .switch{position:relative;width:48px;height:26px;border-radius:999px;background:var(--card2);border:1px solid var(--border);cursor:pointer}
    .knob{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#fff;transition:transform .25s}
    .switch.active .knob{transform:translateX(22px)}

    /* Profile chip + menu */
    .headerProfile{position:relative}
    .profileChip{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card2);cursor:pointer}
    .profileAvatar{width:26px;height:26px;border-radius:999px;overflow:hidden;background:var(--card);border:1px solid var(--border)}
    .profileAvatar img{width:100%;height:100%;object-fit:cover}
    .profileName{font-size:12px;color:var(--muted);max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .profileMenu{position:absolute;right:0;top:42px;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);display:none;min-width:240px;padding:8px}
    .profileMenuItem{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
    .profileMenuItem:hover{background:var(--card2)}
    .profileMenu hr{border:none;border-top:1px solid var(--border);margin:8px 0}

    .searchbar{display:flex;gap:8px;align-items:center;justify-content:center;padding:10px;border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
    .searchbar input{flex:0 1 360px;background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:10px;text-align:center;color:var(--text)}

    /* Layout principal: hilo izquierda + columna derecha */
    main{max-width:1200px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1.6fr .9fr;gap:20px}
    @media (max-width: 980px){ main{grid-template-columns:1fr} }

    /* Feed / hilo */
    .feed{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .section-title{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .thread{display:flex;flex-direction:column;align-items:flex-start;max-width:820px}
    .post{width:100%;display:grid;grid-template-columns:56px 1fr;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
    .post:hover{background:var(--card2)}
    .avatar{width:40px;height:40px;border-radius:999px;overflow:hidden;background:var(--card2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:11px}
    .avatar img{width:100%;height:100%;object-fit:cover}
    .postHeader{display:flex;gap:8px;align-items:center}
    .postTitle{font-size:20px;margin:0;color:var(--headline);font-weight:800}
    .postExcerpt{font-size:15px;color:var(--body);margin-top:6px}
    .thumb{margin-top:10px;border-radius:10px;overflow:hidden}
    .thumb img{width:100%;aspect-ratio:4/3;object-fit:cover;filter:contrast(105%) saturate(108%)}

    .postTags{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .tag{font-size:12px;color:#cfe7ff;background:var(--card2);border:1px solid var(--border);padding:4px 8px;border-radius:999px}

    .postActions{display:flex;gap:14px;margin-top:10px}
    .react{font-size:13px;color:var(--muted);display:flex;gap:6px;align-items:center;cursor:pointer;user-select:none}
    .react svg{width:18px;height:18px;stroke:currentColor;fill:none}
    .react.like.active{color:var(--accent2)}
    .react.share{color:#7fb3ff}

    .feedStatus{font-size:12px;color:var(--muted);padding:8px 14px;border-top:1px solid var(--border)}

    /* Columna derecha portada */
    .rightbar{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .rightHeader{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .rightBox{padding:14px}
    .authorsList{display:grid;grid-template-columns:1fr;gap:10px}
    .authorItem{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--card2)}
    .authorItem .profileAvatar{width:32px;height:32px;border-radius:999px;overflow:hidden}

    /* Lectura + columna derecha */
    .readerPanel{display:none;grid-column:1 / -1}
    .readerLayout{display:grid;grid-template-columns:1.6fr .9fr;gap:20px}
    @media (max-width:980px){ .readerLayout{grid-template-columns:1fr} }
    .readerCard{background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:var(--shadow)}
    .reader{padding:18px;max-width:900px;margin:0 auto}
    .readerTitle{margin:16px 0 6px;font-size:34px;color:var(--headline)}
    .readerMeta{color:var(--muted);font-size:13px;display:none}
    .readerAuthor{display:flex;gap:10px;align-items:center;padding:10px 0;border-top:1px solid var(--border)}
    .readerAuthor .profileAvatar{width:36px;height:36px;border-radius:999px;overflow:hidden}
    .readerActions{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
    .readerActions .btn{display:flex;gap:8px;align-items:center}
    .readerBody{margin-top:16px;line-height:1.9;font-size:18px;color:var(--body);text-align:center}
    .readerBody img{border-radius:14px;margin:12px auto;display:block;max-width:95%}
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo"></div>
        <h1>El Metro Diario</h1>
      </div>
      <div class="actions">
        <div id="themeSwitch" class="switch" title="Tema"><div class="knob"></div></div>

        <div class="headerProfile">
          <div id="profileChip" class="profileChip" style="display:none">
            <div class="profileAvatar"><img id="profileImg" alt=""></div>
            <div class="profileName" id="profileName">Mi cuenta</div>
          </div>
          <div id="profileMenu" class="profileMenu">
            <div class="profileMenuItem">
              <div class="profileAvatar"><img id="menuImg" alt=""></div>
              <div>
                <div id="menuName" style="font-weight:600;color:var(--headline)">Nombre</div>
                <div id="menuEmail" style="font-size:12px;color:var(--muted)">email</div>
              </div>
            </div>
            <hr />
            <div class="profileMenuItem" id="openComposerFromMenu">‚úçÔ∏è Nueva publicaci√≥n</div>
            <div class="profileMenuItem" id="logoutBtn">üö™ Cerrar sesi√≥n</div>
          </div>
        </div>

        <button id="loginBtn" class="btn">Iniciar sesi√≥n</button>
        <button id="openComposer" class="btn primary">Publicar</button>
      </div>
    </div>

    <div class="searchbar">
      <input id="q" type="search" placeholder="Buscar noticias..." />
    </div>
  </header>

  <main>
    <!-- Hilo izquierda -->
    <section class="feed">
      <div class="section-title"><strong>Portada</strong></div>
      <div id="thread" class="thread"></div>
      <div id="feedStatus" class="feedStatus"></div>
    </section>

    <!-- Columna derecha portada -->
    <aside class="rightbar" id="homeRightbar">
      <div class="rightHeader"><strong>Autores activos</strong></div>
      <div class="rightBox">
        <div id="authorsList" class="authorsList"></div>
      </div>
      <div class="rightHeader"><strong>Accesos</strong></div>
      <div class="rightBox">
        <button class="btn" id="openReaderPanel">Abrir lector</button>
      </div>
    </aside>

    <!-- Lectura con columna derecha -->
    <section class="readerPanel" id="readerPanel">
      <div class="readerLayout">
        <div class="readerCard">
          <div class="section-title"><strong>Lectura</strong></div>
          <div class="reader">
            <h1 class="readerTitle" id="viewTitle"></h1>

            <div class="readerAuthor">
              <div class="profileAvatar"><img id="readerAuthorImg" alt=""></div>
              <div>
                <div id="readerAuthorName" style="font-weight:600;color:var(--headline)">Autor</div>
                <div id="readerAuthorEmail" style="font-size:12px;color:var(--muted)"></div>
              </div>
            </div>

            <div class="readerActions">
              <button class="btn" id="viewLikeBtn">
                <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9.33-7.34A5.51 5.51 0 0 1 7.5 4.5c1.54 0 3.04.7 4.5 2.1 1.46-1.4 2.96-2.1 4.5-2.1a5.51 5.51 0 0 1 4.83 9.16C19 16.65 12 21 12 21Z" stroke-width="1.6"/></svg>
                Me gusta <span id="viewLikeCount">0</span>
              </button>
              <button class="btn ghost" id="closePost">Volver</button>
            </div>

            <div class="readerBody" id="viewContent"></div>
          </div>
        </div>

        <aside class="rightbar" id="readerRightbar">
          <div class="rightHeader"><strong>Resumen</strong></div>
          <div class="rightBox" id="readerSummary"></div>
        </aside>
      </div>
    </section>
  </main>

  <!-- Composer local -->
  <div class="composerModal" id="composerModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);align-items:center;justify-content:center;z-index:200">
    <div class="tweetComposer" style="width:760px;max-width:96%;background:var(--card);border:1px solid var(--border);border-radius:18px;box-shadow:var(--shadow);display:grid;grid-template-columns:56px 1fr;gap:12px;padding:14px 16px">
      <div class="avatar"><img id="composerImg" alt="" style="display:none;width:40px;height:40px;border-radius:999px;object-fit:cover"><span id="composerFallback">ED</span></div>
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <strong>Crear publicaci√≥n</strong>
          <button class="btn" id="closeComposer">Cerrar</button>
        </div>
        <div class="composerTitle">
          <input type="text" id="newTitle" placeholder="Titular claro y legible" style="width:100%;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text);font-size:18px;font-weight:700;text-align:center" />
        </div>
        <div id="editor" class="composerEditor" contenteditable="true" spellcheck="true" style="min-height:160px;padding:12px;background:var(--card2);border:1px solid var(--border);border-radius:12px;color:var(--text)"></div>
        <div class="uploader" style="text-align:center;margin-top:10px">
          <input type="file" id="newImages" multiple accept="image/*" />
          <div class="previewImgs" id="previewImgs" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;justify-content:center"></div>
        </div>
        <div class="composerActions" style="display:flex;gap:8px;justify-content:center;margin-top:10px">
          <button class="btn primary" id="publishBtn">Publicar</button>
        </div>
        <div id="composeStatus" class="composeStatus" style="text-align:center;font-size:12px;color:var(--muted);margin-top:6px;min-height:18px"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====
    const BLOG_ID = "5213119795675357751";
    const API_KEY = "AIzaSyCARk0pc3s7y3VLUTi6LNuSpP-FD2l7OtI";
    const GOOGLE_CLIENT_ID = "723966225091-ge8ai8v13m60l7g9bma5b4hsuqmuh01n.apps.googleusercontent.com";

    // ===== Estado =====
    const state = {
      posts: [],
      localPosts: JSON.parse(localStorage.getItem("localPosts") || "[]"),
      likes: JSON.parse(localStorage.getItem("likes") || "{}"),
      theme: localStorage.getItem("theme") || "dark",
      user: JSON.parse(localStorage.getItem("sessionUser") || "null"),
      authors: JSON.parse(localStorage.getItem("authors") || "[]"),
      uploadDataUrls: []
    };

    // ===== Tema =====
    function applyTheme() {
      document.documentElement.setAttribute("data-theme", state.theme);
      const sw = document.getElementById("themeSwitch");
      sw.classList.toggle("active", state.theme === "light");
    }
    function toggleTheme() {
      state.theme = state.theme === "light" ? "dark" : "light";
      localStorage.setItem("theme", state.theme);
      applyTheme();
    }
    document.getElementById("themeSwitch").addEventListener("click", toggleTheme);
    applyTheme();

    // ===== Utilidades =====
    function escapeHtml(s=""){ return s.replace(/[&<>"']/g, m => ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[m])); }
    function extractImages(html){
      const doc = new DOMParser().parseFromString(html || "", "text/html");
      return [...doc.querySelectorAll("img")].map(img => img.src).filter(Boolean);
    }
    function extractExcerpt(html, len=220){
      const text = new DOMParser().parseFromString(html || "", "text/html").body.textContent || "";
      return text.length > len ? text.slice(0, len).trim() + "‚Ä¶" : text;
    }
    function notify(msg, type="info") {
      const el = document.getElementById("feedStatus");
      const color = type==="ok" ? "var(--ok)" : type==="warn" ? "var(--warn)" : type==="err" ? "var(--err)" : "var(--muted)";
      el.style.color = color; el.textContent = msg;
      clearTimeout(notify._t); notify._t = setTimeout(()=>{ el.textContent = ""; }, 3500);
    }
    function findAuthorPictureByName(name){
      if (!name) return "";
      const hit = state.authors.find(a => (a.name||"").trim().toLowerCase() === name.trim().toLowerCase());
      return hit?.picture || "";
    }

    // ===== Perfil persistente =====
    function showProfileChip({name, email, picture}){
      const chip = document.getElementById("profileChip");
      const img = document.getElementById("profileImg");
      const nameEl = document.getElementById("profileName");
      const menu = document.getElementById("profileMenu");
      document.getElementById("menuImg").src = picture || "";
      document.getElementById("menuName").textContent = name || "Usuario";
      document.getElementById("menuEmail").textContent = email || "";
      img.src = picture || "";
      img.style.display = picture ? "block" : "none";
      nameEl.textContent = name || email || "Mi cuenta";
      chip.style.display = "flex";
      chip.onclick = () => { menu.style.display = (menu.style.display === "block") ? "none" : "block"; };
      document.addEventListener("click", (e)=>{ if (!chip.contains(e.target) && !menu.contains(e.target)) menu.style.display = "none"; });
      document.getElementById("openComposerFromMenu").onclick = () => { menu.style.display = "none"; openComposer(); };
      document.getElementById("logoutBtn").onclick = logout;
    }
    function updateComposerAvatar(user){
      const img = document.getElementById("composerImg");
      const fb = document.getElementById("composerFallback");
      if (user?.picture){ img.src = user.picture; img.style.display="block"; fb.style.display="none"; }
      else { img.style.display="none"; fb.style.display="inline"; }
    }
    function syncSessionUI(){
      if (state.user){
        document.getElementById("loginBtn").textContent = "Cerrar sesi√≥n";
        showProfileChip(state.user);
        updateComposerAvatar(state.user);
      } else {
        document.getElementById("loginBtn").textContent = "Iniciar sesi√≥n";
        document.getElementById("profileChip").style.display = "none";
        document.getElementById("profileMenu").style.display = "none";
      }
    }

    // ===== OAuth (perfil, persistente) =====
    const OAUTH_SCOPES = "openid https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";
    (function setupAuth(){
      const s = document.createElement("script");
      s.src = "https://accounts.google.com/gsi/client";
      s.async = true; s.defer = true;
      s.onload = () => {
        syncSessionUI();
        document.getElementById("loginBtn").addEventListener("click", () => {
          if (state.user){ logout(); return; }
          const client = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID, scope: OAUTH_SCOPES, prompt: "consent",
            callback: async (resp) => {
              if (resp && resp.access_token){
                try{
                  const ui = await fetch("https://www.googleapis.com/oauth2/v3/userinfo", { headers:{ Authorization:`Bearer ${resp.access_token}` } }).then(r=>r.json());
                  state.user = { name: ui.name, email: ui.email, picture: ui.picture, accessToken: resp.access_token };
                  localStorage.setItem("sessionUser", JSON.stringify(state.user));
                  syncSessionUI();
                  notify("Autenticado.", "ok");
                }catch(e){ notify("No se pudo obtener el perfil.", "err"); }
              }else{ notify("Sin token.", "err"); }
            }
          });
          client.requestAccessToken();
        });
      };
      document.head.appendChild(s);
    })();
    function logout(){
      state.user = null;
      localStorage.removeItem("sessionUser");
      syncSessionUI();
      notify("Sesi√≥n cerrada.", "warn");
    }

    // ===== Blogger (read-only) =====
    async function fetchPosts({ q = "", maxResults = 25 } = {}) {
      const params = new URLSearchParams({
        key: API_KEY, fetchBodies: "true", maxResults: String(maxResults),
        fields: "items(id,title,content,labels,author/displayName,published,url,selfLink)"
      });
      if (q) params.set("q", q);
      const url = `https://www.googleapis.com/blogger/v3/blogs/${BLOG_ID}/posts?${params.toString()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("Error al cargar posts");
      return res.json();
    }

    // ===== Autores activos (portada derecha) =====
    function renderAuthorsRightbar(){
      const el = document.getElementById("authorsList");
      el.innerHTML = "";
      state.authors.sort((a,b)=> (b.posts||0)-(a.posts||0));
      state.authors.forEach(a=>{
        const div = document.createElement("div");
        div.className = "authorItem";
        div.innerHTML = `
          <div class="profileAvatar"><img src="${a.picture||""}" alt=""></div>
          <div>
            <div style="font-weight:600;color:var(--headline)">${escapeHtml(a.name||a.email||"Autor")}</div>
            <div style="font-size:12px;color:var(--muted)">${escapeHtml(a.email||"")}</div>
            <div style="font-size:12px;color:var(--muted)">Posts: ${a.posts||0}</div>
          </div>
        `;
        el.appendChild(div);
      });
    }

    // ===== Hilo (mezcla locales arriba + blog) =====
    function renderThread(){
      const list = document.getElementById("thread");
      list.innerHTML = "";
      const items = [
        ...state.localPosts.map(lp => ({ ...lp, isLocal: true })),
        ...state.posts.map(p => ({ ...p, isLocal: false }))
      ];

      items.forEach(p => {
        const container = document.createElement("article");
        container.className = "post";

        // Avatar: locales usan foto Google del autor, blog intenta mapear por nombre
        let avatarHtml = "";
        if (p.isLocal){
          avatarHtml = p.author?.picture ? `<img src="${p.author.picture}" alt="">` : `<span>ED</span>`;
        } else {
          const mappedPic = findAuthorPictureByName(p.author?.displayName || "");
          avatarHtml = mappedPic ? `<img src="${mappedPic}" alt="">`
            : `<svg viewBox="0 0 24 24" style="width:20px;height:20px"><circle cx="12" cy="8" r="4" stroke="currentColor" fill="none"/><path d="M4 20c0-4.418 3.582-8 8-8s8 3.582 8 8" stroke="currentColor" fill="none"/></svg>`;
        }

        // Miniatura √∫nica (solo 1)
        const thumb = p.isLocal
          ? (p.images && p.images[0]) || ""
          : (p.content ? extractImages(p.content)[0] : "");

        const excerpt = extractExcerpt(p.content || "", 240);

        container.innerHTML = `
          <div class="avatar">${avatarHtml}</div>
          <div>
            <div class="postHeader">
              <h3 class="postTitle"><a href="#" data-open="${p.isLocal ? p.localId : p.id}" data-local="${p.isLocal ? 1 : 0}" class="open-post">${escapeHtml(p.title||"(Sin t√≠tulo)")}</a></h3>
            </div>
            <div class="postExcerpt">${escapeHtml(excerpt)}</div>
            ${thumb ? `<div class="thumb"><img src="${thumb}" alt=""></div>` : ""}
            <div class="postTags">${(p.labels||[]).map(l => `<span class="tag">${escapeHtml(l)}</span>`).join("")}</div>
            <div class="postActions">
              <div class="react like" data-like="${p.isLocal ? p.localId : p.id}">
                <svg viewBox="0 0 24 24"><path d="M12 21s-7-4.35-9.33-7.34A5.51 5.51 0 0 1 7.5 4.5c1.54 0 3.04.7 4.5 2.1 1.46-1.4 2.96-2.1 4.5-2.1a5.51 5.51 0 0 1 4.83 9.16C19 16.65 12 21 12 21Z" stroke-width="1.6"/></svg>
                <span>${state.likes[p.isLocal ? p.localId : p.id]?.count || 0}</span>
              </div>
              <div class="react share" data-share="${p.isLocal ? p.localId : p.id}">
                <svg viewBox="0 0 24 24"><path d="M4 12v7a1 1 0 0 0 1 1h14a1 1 0 0 0 1-1v-7M12 16V4m0 0 4 4m-4-4-4 4" stroke-width="1.6"/></svg>
                <span>Compartir</span>
              </div>
            </div>
          </div>
        `;
        list.appendChild(container);
      });

      // Eventos
      list.querySelectorAll(".open-post").forEach(a => {
        a.addEventListener("click", (e) => {
          e.preventDefault();
          const id = a.getAttribute("data-open");
          const isLocal = a.getAttribute("data-local") === "1";
          const post = isLocal ? state.localPosts.find(x => String(x.localId) === String(id)) : state.posts.find(x => x.id === id);
          if (post) openReader(post, isLocal);
        });
      });
      list.querySelectorAll("[data-like]").forEach(btn => {
        btn.addEventListener("click", () => {
          if (!state.user){ notify("Debes iniciar sesi√≥n para dar like.", "warn"); return; }
          const id = btn.getAttribute("data-like");
          toggleLike(id, btn);
          btn.classList.toggle("active", (state.likes[id]||{}).liked);
        });
      });
      list.querySelectorAll("[data-share]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-share");
          const post = state.localPosts.find(x=>String(x.localId)===String(id)) || state.posts.find(x=>x.id===id);
          const title = post?.title || "El Metro Diario";
          try{
            if (navigator.share) await navigator.share({ title, text:title, url: location.href });
            else { await navigator.clipboard.writeText(location.href); notify("Enlace copiado.", "ok"); }
          }catch(e){ notify("No se pudo compartir.", "err"); }
        });
      });
    }

    // ===== Lectura (una sola imagen, sin duplicados) =====
    function openReader(p, isLocal=false){
      document.querySelector(".feed").style.display = "none";
      document.getElementById("homeRightbar").style.display = "none";
      document.getElementById("readerPanel").style.display = "block";

      const title = p.title || "(Sin t√≠tulo)";
      const contentHtml = p.content || "";

      // Autor (para locales, foto/email de Google; para blog, intenta mapear por nombre)
      const authorName = isLocal ? (p.author?.displayName || state.user?.name || "Autor") : (p.author?.displayName || "Autor");
      const authorEmail = isLocal ? (p.author?.email || state.user?.email || "") : "";
      const authorPicture = isLocal ? (p.author?.picture || state.user?.picture || "") : findAuthorPictureByName(authorName);

      document.getElementById("viewTitle").textContent = title;
      document.getElementById("readerAuthorImg").src = authorPicture || "";
      document.getElementById("readerAuthorName").textContent = authorName;
      document.getElementById("readerAuthorEmail").textContent = authorEmail;

      const body = document.getElementById("viewContent");
      body.innerHTML = "";

      const doc = new DOMParser().parseFromString(contentHtml, "text/html");
      const imgs = [...doc.querySelectorAll("img")];
      const firstSrc = imgs[0]?.src || "";

      // Mostrar solo UNA imagen: usamos la primera como portada dentro del cuerpo
      if (firstSrc){
        const first = document.createElement("img");
        first.src = firstSrc;
        first.alt = "Portada";
        body.appendChild(first);
      }
      // Eliminar de doc cualquier imagen con el mismo src (evita duplicados)
      imgs.forEach(img => { if (img.src === firstSrc) img.remove(); });

      // Insertar resto de contenido (sin duplicar esa primera imagen)
      doc.querySelectorAll("img").forEach(img=>{
        img.loading="lazy";
        img.style.display="block";
        img.style.margin="12px auto";
        img.style.borderRadius="14px";
        img.style.maxWidth="95%";
      });
      [...doc.body.childNodes].forEach(node=>{
        if (node.nodeType===1) body.appendChild(node);
        else if (node.nodeType===3 && node.textContent.trim()){
          const pEl = document.createElement("p"); pEl.textContent = node.textContent.trim(); body.appendChild(pEl);
        }
      });

      // Likes lectura
      const likeId = isLocal ? p.localId : p.id;
      const like = state.likes[likeId] || { count:0, liked:false };
      document.getElementById("viewLikeCount").textContent = like.count;
      document.getElementById("viewLikeBtn").onclick = ()=>{
        if (!state.user){ notify("Debes iniciar sesi√≥n para dar like.", "warn"); return; }
        toggleLike(likeId);
        document.getElementById("viewLikeCount").textContent = (state.likes[likeId]||{count:0}).count;
      };

      // Resumen derecha
      const allImagesCount = (firstSrc ? 1 : 0) + [...doc.querySelectorAll("img")].length;
      document.getElementById("readerSummary").innerHTML = `
        <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed var(--border)"><span>Im√°genes</span><span>${allImagesCount}</span></div>
        <div style="display:flex;justify-content:space-between;padding:6px 0"><span>Longitud</span><span>${(contentHtml||"").length} chars</span></div>
      `;
    }
    document.getElementById("closePost").addEventListener("click", ()=>{
      document.getElementById("readerPanel").style.display = "none";
      document.querySelector(".feed").style.display = "block";
      document.getElementById("homeRightbar").style.display = "block";
    });
    document.getElementById("openReaderPanel").addEventListener("click", ()=>{
      const p = state.localPosts[0] || state.posts[0];
      if (p) openReader(p, !!p.localId);
    });

    // ===== Likes =====
    function toggleLike(id, btnEl){
      const like = state.likes[id] || { count: 0, liked: false };
      like.liked = !like.liked;
      like.count += like.liked ? 1 : (like.count>0 ? -1 : 0);
      state.likes[id] = like;
      localStorage.setItem("likes", JSON.stringify(state.likes));
      if (btnEl){
        const span = btnEl.querySelector("span");
        if (span) span.textContent = like.count;
      }
    }

    // ===== Composer (local) =====
    const composerModal = document.getElementById("composerModal");
    function openComposer(){
      if (!state.user){ notify("Debes iniciar sesi√≥n para publicar.", "warn"); return; }
      composerModal.style.display = "flex";
      updateComposerAvatar(state.user);
    }
    document.getElementById("openComposer").addEventListener("click", openComposer);
    document.getElementById("closeComposer").addEventListener("click", ()=> composerModal.style.display="none");
    document.getElementById("newImages").addEventListener("change", function(){
      const preview = document.getElementById("previewImgs");
      preview.innerHTML = ""; state.uploadDataUrls = [];
      [...this.files].forEach(file=>{
        const reader = new FileReader();
        reader.onload = e=>{
          const url = e.target.result; state.uploadDataUrls.push(url);
          const img = document.createElement("img"); img.src = url; img.style.width="100px"; img.style.height="100px"; img.style.objectFit="cover"; img.style.borderRadius="10px";
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });
    document.getElementById("publishBtn").addEventListener("click", ()=>{
      const title = document.getElementById("newTitle").value.trim();
      const editor = document.getElementById("editor");
      const status = document.getElementById("composeStatus");
      if (!state.user){ status.style.color="var(--err)"; status.textContent="Debes iniciar sesi√≥n."; return; }
      if (!title){ status.style.color="var(--err)"; status.textContent="Pon un t√≠tulo claro."; return; }
      const contentHtml = editor.innerHTML + state.uploadDataUrls.map(url=>`<p><img src="${url}" alt=""></p>`).join("");
      const localPost = {
        localId: Date.now().toString(),
        title,
        content: contentHtml,
        labels: [],
        author: { displayName: state.user.name, email: state.user.email, picture: state.user.picture },
        images: state.uploadDataUrls.slice(0),
        published: new Date().toISOString()
      };
      state.localPosts.unshift(localPost);
      localStorage.setItem("localPosts", JSON.stringify(state.localPosts));

      // Registrar autor activo
      const idx = state.authors.findIndex(a=>a.email===state.user.email);
      if (idx>=0) state.authors[idx].posts = (state.authors[idx].posts||0)+1;
      else state.authors.push({ name: state.user.name, email: state.user.email, picture: state.user.picture, posts: 1 });
      localStorage.setItem("authors", JSON.stringify(state.authors));
      renderAuthorsRightbar();

      status.style.color="var(--ok)"; status.textContent="Publicado localmente.";
      composerModal.style.display="none";
      editor.innerHTML=""; document.getElementById("newTitle").value="";
      state.uploadDataUrls=[]; document.getElementById("previewImgs").innerHTML="";
      renderThread();
    });

    // ===== B√∫squeda =====
    document.getElementById("q").addEventListener("input", ()=>{
      const q = document.getElementById("q").value.trim().toLowerCase();
      const list = document.getElementById("thread"); list.innerHTML="";
      const items = [
        ...state.localPosts.map(lp=>({ ...lp, isLocal:true })),
        ...state.posts.map(p=>({ ...p, isLocal:false }))
      ].filter(p => (p.title||"").toLowerCase().includes(q) || (p.content||"").toLowerCase().includes(q));
      if (!items.length){ list.innerHTML = `<div style="padding:14px;color:var(--muted)">Sin resultados.</div>`; return; }
      items.forEach(p=>{
        const container=document.createElement("article");container.className="post";
        const avatarHtml = p.isLocal
          ? (p.author?.picture ? `<img src="${p.author.picture}" alt="">` : `<span>ED</span>`)
          : (findAuthorPictureByName(p.author?.displayName||"") ? `<img src="${findAuthorPictureByName(p.author?.displayName||"")}" alt="">`
             : `<svg viewBox="0 0 24 24" style="width:20px;height:20px"><circle cx="12" cy="8" r="4" stroke="currentColor" fill="none"/><path d="M4 20c0-4.418 3.582-8 8-8s8 3.582 8 8" stroke="currentColor" fill="none"/></svg>`);
        const thumb = p.isLocal ? (p.images && p.images[0]) || "" : (p.content ? extractImages(p.content)[0] : "");
        const excerpt = extractExcerpt(p.content||"", 240);
        container.innerHTML = `
          <div class="avatar">${avatarHtml}</div>
          <div>
            <div class="postHeader"><h3 class="postTitle"><a href="#" data-open="${p.isLocal ? p.localId : p.id}" data-local="${p.isLocal ? 1 : 0}" class="open-post">${escapeHtml(p.title||"(Sin t√≠tulo)")}</a></h3></div>
            <div class="postExcerpt">${escapeHtml(excerpt)}</div>
            ${thumb ? `<div class="thumb"><img src="${thumb}" alt=""></div>` : ""}
          </div>`;
        list.appendChild(container);
      });
      list.querySelectorAll(".open-post").forEach(a=>{
        a.addEventListener("click",(e)=>{
          e.preventDefault();
          const id = a.getAttribute("data-open");
          const isLocal = a.getAttribute("data-local")==="1";
          const post = isLocal ? state.localPosts.find(x=>String(x.localId)===String(id)) : state.posts.find(x=>x.id===id);
          if (post) openReader(post, isLocal);
        });
      });
    });

    // ===== Carga inicial =====
    async function load() {
      const status = document.getElementById("feedStatus");
      status.style.color = "var(--muted)";
      status.textContent = "Cargando noticias‚Ä¶";
      try {
        const data = await fetchPosts({ maxResults: 25 });
        state.posts = data.items || [];
        status.textContent = `Mostrando ${state.posts.length + state.localPosts.length} (incluye locales).`;
      } catch (err) {
        status.style.color = "var(--warn)";
        status.textContent = "No se pudieron cargar las noticias del blog. Mostrando locales.";
      }
      renderThread();
      renderAuthorsRightbar();
    }

    load();
  </script>
</body>
</html>
